version: '3'

includes:
  internal:
    taskfile: ./Taskfile.internal.yml
    internal: true
  ci:
    taskfile: ./Taskfile.ci.yml
    internal: false

tasks:
  default:
    desc: Show all available tasks
    cmds:
      - task --list-all

# #################################################
# Testing Tasks
# #################################################
  test-unit:
    desc: Run unit tests (fast, no Docker required)
    summary: |
      Runs all unit tests in the resilience package.
      - Fast execution (~1-2 seconds)
      - No external dependencies
      - Uses race detector
      - Verbose output
    cmds:
      - go test -race -v ./resilience

  test-integration:
    desc: Run integration tests (slower, requires Docker)
    summary: |
      Runs all integration tests that require Docker.
      - Uses testcontainers-go to manage Kafka
      - Tests: full retry flow, DLQ, restart recovery, FIFO ordering
      - Duration: ~3-5 minutes
      - Requires Docker daemon running
      - Always runs fresh (cache disabled with -count=1)
    cmds:
      - cd adapter/sarama && go test -race -v -count=1 -tags=integration .

  test:
    desc: Run all tests (unit + integration)
    summary: |
      Runs both unit and integration tests.
      - First runs fast unit tests
      - Then runs slower integration tests
      - Total duration: ~3-5 minutes
    cmds:
      - task: test-unit
      - task: test-integration
      - echo "üéâ All tests passed!"

  test-coverage:
    desc: Run tests with coverage report
    summary: |
      Generates coverage report for unit tests.
      - Excludes mock files
      - Outputs to coverage.out
      - Use with: go tool cover -html=coverage.out
    cmds:
      - go list ./resilience/... | grep -v /mock_ > packages.out
      - go test -gcflags=-l -covermode=atomic -coverprofile=coverage.tmp -race $(cat packages.out)
      - cat coverage.tmp | grep -v mock_ > coverage.out
      - rm coverage.tmp packages.out
      - echo "‚úÖ Coverage report saved to coverage.out"
      - go tool cover -func=coverage.out | tail -1

  test-watch:
    desc: Watch and run unit tests on file changes
    summary: |
      Continuously watches for file changes and runs unit tests.
      Requires: github.com/cespare/reflex
      Install: go install github.com/cespare/reflex@latest
    cmds:
      - reflex -r '\.go$' -s -- sh -c 'clear && task test-unit'

# #################################################
# Code Quality Tasks
# #################################################
  lint:
    desc: Run linter checks
    summary: |
      Runs golangci-lint with project configuration.
      - Uses .golangci.yml config
      - Checks code style, bugs, performance
    cmds:
      - golangci-lint run -c .golangci.yml

  fmt:
    desc: Format project files
    summary: |
      Formats all Go files and fixes linter issues.
      - Uses gofumpt for formatting
      - Runs golangci-lint --fix for auto-fixes
    cmds:
      - find . -name '*.go' -type f -exec gofumpt -w {} +
      - golangci-lint run --fix

  clean:
    desc: Clean up and format code
    summary: |
      Tidies Go modules and formats code.
      - Runs go mod tidy
      - Formats all Go files
      - Fixes linter issues
    cmds:
      - go mod tidy
      - defer: {task: fmt}

  update-deps:
    desc: Update Go dependencies
    summary: |
      Updates all Go dependencies to latest versions.
      Warning: Review changes before committing.
    cmds:
      - go get -u ./...
      - go mod tidy

# #################################################
# Build Tasks
# #################################################
  build:
    desc: Build the project
    summary: |
      Builds the Go binary.
      - CGO disabled for static binary
      - Output to dist/ directory
    vars:
      BUILD_DIR: '{{.BUILD_DIR | default "dist"}}'
      BINARY: '{{.BINARY | default "kafetrain"}}'
    cmds:
      - mkdir -p {{.BUILD_DIR}}
      - CGO_ENABLED=0 go build -o {{.BUILD_DIR}}/{{.BINARY}} .

  build-example:
    desc: Build example applications
    summary: |
      Builds all example applications in examples/ directory.
      - CGO disabled
      - Output to dist/ directory
    vars:
      BUILD_DIR: '{{.BUILD_DIR | default "dist"}}'
      EXAMPLES: simple_consumer stream error_tracker
    cmds:
      - mkdir -p {{.BUILD_DIR}}
      - for: { var: EXAMPLES, split: ' ' }
        cmd: CGO_ENABLED=0 go build -o {{.BUILD_DIR}}/{{.ITEM}} ./examples/{{.ITEM}}

# #################################################
# CI/CD Tasks
# #################################################
  ci:prepare-release:
    desc: Prepares release
    summary: |
      Usage: task prepare-release VERSION=1.1.0
      1. Runs linters and tests.
      2. Extracts release notes from CHANGELOG.md.
      3. Updates CHANGELOG.md with the new version tag.
    vars:
      VERSION: '{{.VERSION}}'
    preconditions:
      - sh: 'test -n "{{.VERSION}}"'
        msg: "VERSION variable is required. Usage: task ci:prepare-release VERSION=1.2.3"
      - sh: 'echo "{{.VERSION}}" | grep -qE "^[0-9]+\.[0-9]+\.[0-9]+$"'
        msg: "Version format must be 'X.Y.Z'. Passed: {{.VERSION}}"
      - sh: "test -n \"$(awk '/^## \\[Unreleased\\]/{flag=1; next} /^## \\[/{flag=0} flag' CHANGELOG.md)\""
        msg: "‚ùå The [Unreleased] section in CHANGELOG.md is empty. Nothing to release."
    cmds:
      - task: ci:check-version-bump
        vars: { VERSION: "{{.VERSION}}" }
      - task: ci:changelog:extract
      - task: ci:changelog:update
        vars: { VERSION: "v{{.VERSION}}" }
